@model IEnumerable<SocialMedia.Application.Dtos.PostDto>
@using Humanizer // For making the date look user-friendly

@{
    ViewData["Title"] = "Feed";
}

<div class="container">
    <h1 class="my-4">@ViewData["Title"]</h1>

    <p>
        <a asp-action="CreatePost" asp-controller="Post" class="btn btn-primary">Create New Post</a>
    </p>

    @if (!Model.Any())
    {
        <p>No posts yet. Be the first to create one!</p>
    }
    else
    {
        @foreach (var post in Model)
        {
            <div class="card mb-3">
                <div class="card-body">
                    @{
                        var reactionUsers = post.Reactions.Any()
                        ? string.Join(", ", post.Reactions.Select(r => $"{r.UserName} ({r.ReactionType})"))
                        : "No reactions yet";
                    }

                    <h5 class="card-title">@post.AuthorfullName</h5>
                    <h6 class="card-subtitle mb-2 text-muted">@post.CreatedDate.Humanize()</h6>
                    <p class="card-text">@post.Content</p>

                    @if (post.Images.Any())
                    {
                        <div class="d-flex flex-wrap">
                            @foreach (var image in post.Images)
                            {
                                <img src="@image.ImagePath" class="img-thumbnail" alt="Post Image" style="max-width: 200px; margin: 5px;" />
                            }
                        </div>
                    }

                    <hr />
                    <div class="d-flex justify-content-between align-items-center">
                        <p class="card-text mb-0">
                            <small class="text-muted"
                                   data-bs-toggle="tooltip"
                                   data-bs-placement="top"
                                   title="@reactionUsers">
                                @post.ReactionCount Reactions
                            </small>
                        </p>

                        <form asp-action="AddReaction" asp-controller="Post" method="post">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="postId" value="@post.Id" />
                            <button type="submit" name="reactionType" value="Like" class="btn btn-light">👍 Like</button>
                            <button type="submit" name="reactionType" value="Love" class="btn btn-light">❤️ Love</button>
                        </form>
                    </div>
                </div>
            </div>
        }
    }
</div>

@section Scripts {
    <script>
        // Find all elements with the data-bs-toggle="tooltip" attribute and initialize them
        document.addEventListener("DOMContentLoaded", function() {
            var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
            var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl)
            })
        });
    </script>
}